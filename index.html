<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 0;
        }

        .top-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .school-name {
            font-size: 18px;
            font-weight: bold;
            color: #1e3c72;
        }

        .school-name.empty {
            color: #999;
            font-style: italic;
        }

        .top-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-top {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-settings {
            background: #667eea;
            color: white;
        }

        .btn-export {
            background: #26de81;
            color: white;
        }

        .btn-stats {
            background: #ffa502;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            overflow-x: auto;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab.active {
            color: #1e3c72;
            background: white;
            border-bottom-color: #1e3c72;
        }

        .content {
            padding: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .select-box {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            min-width: 150px;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-success {
            background: #26de81;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .student-card {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .student-card:hover {
            border-color: #1e3c72;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .student-name {
            font-weight: bold;
            font-size: 17px;
            color: #1e3c72;
        }

        .student-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 8px;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-btn {
            flex: 1;
            min-width: 90px;
            padding: 10px;
            border: 2px solid;
            border-radius: 8px;
            background: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .status-btn.present {
            border-color: #26de81;
            color: #26de81;
        }

        .status-btn.present.active {
            background: #26de81;
            color: white;
        }

        .status-btn.absent {
            border-color: #ff4757;
            color: #ff4757;
        }

        .status-btn.absent.active {
            background: #ff4757;
            color: white;
        }

        .status-btn.late {
            border-color: #ffa502;
            color: #ffa502;
        }

        .status-btn.late.active {
            background: #ffa502;
            color: white;
        }

        .status-btn.completed.active {
            background: #26de81;
            color: white;
        }

        .status-btn.incomplete {
            border-color: #ff4757;
            color: #ff4757;
        }

        .status-btn.incomplete.active {
            background: #ff4757;
            color: white;
        }

        .status-btn.partial {
            border-color: #ffa502;
            color: #ffa502;
        }

        .status-btn.partial.active {
            background: #ffa502;
            color: white;
        }

        .note-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .note-text {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .note-text.empty {
            color: #999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1e3c72;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-input {
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .session-info {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .session-label {
            font-weight: bold;
            color: #1e3c72;
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .top-actions {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="school-name" id="displaySchoolName">Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
        <div class="top-actions">
            <button class="btn-top btn-settings" onclick="openSettings()">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="btn-top btn-stats" onclick="switchTab('statistics')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button class="btn-top btn-export" onclick="openExportModal()">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('classes')">Ø§Ù„ÙØµÙˆÙ„</button>
            <button class="tab" onclick="switchTab('students')">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button class="tab" onclick="switchTab('attendance')">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
            <button class="tab" onclick="switchTab('participation')">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
            <button class="tab" onclick="switchTab('homework')">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</button>
        </div>

        <div class="content">
            <!-- Classes Tab -->
            <div id="classesTab">
                <div class="input-group">
                    <input type="text" id="classNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: 1Ø£)" class="form-input" style="flex:1">
                    <button class="btn btn-primary" onclick="addClass()">â• Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
                </div>
                <div id="classesList"></div>
            </div>

            <!-- Students Tab -->
            <div id="studentsTab" class="hidden">
                <div class="search-bar">
                    <input type="text" id="studentSearch" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="updateUI()">
                    <select id="filterClass" class="select-box" onchange="updateUI()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                    <select id="sortStudents" class="select-box" onchange="updateUI()">
                        <option value="name">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…</option>
                        <option value="class">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</option>
                        <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="studentNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" style="flex:1">
                    <select id="studentClassSelect" style="min-width:120px">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
                    </select>
                    <button class="btn btn-primary" onclick="addStudent()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                </div>
                <div id="studentsList"></div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendanceTab" class="hidden">
                <div class="session-info">
                    <div class="session-item">
                        <span class="session-label">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                        <span id="attendanceDate"></span>
                    </div>
                    <div class="session-item">
                        <span class="session-label">ğŸ“š Ø§Ù„Ø­ØµØ©:</span>
                        <select id="sessionSelect" onchange="updateUI()">
                            <option value="1">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                            <option value="2">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                            <option value="3">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
                            <option value="4">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option>
                            <option value="5">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø®Ø§Ù…Ø³Ø©</option>
                            <option value="6">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø©</option>
                            <option value="7">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©</option>
                        </select>
                    </div>
                    <div class="session-item">
                        <span class="session-label">ğŸ« Ø§Ù„ÙØµÙ„:</span>
                        <select id="attendanceClassFilter" onchange="updateUI()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                        </select>
                    </div>
                </div>
                <div id="attendanceList"></div>
            </div>

            <!-- Participation Tab -->
            <div id="participationTab" class="hidden">
                <div class="search-bar">
                    <select id="participationClassFilter" class="select-box" onchange="updateUI()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                </div>
                <div id="participationList"></div>
            </div>

            <!-- Homework Tab -->
            <div id="homeworkTab" class="hidden">
                <div class="session-info">
                    <div class="session-item">
                        <span class="session-label">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                        <span id="homeworkDate"></span>
                    </div>
                    <div class="session-item">
                        <span class="session-label">ğŸ« Ø§Ù„ÙØµÙ„:</span>
                        <select id="homeworkClassFilter" onchange="updateUI()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                        </select>
                    </div>
                </div>
                <div id="homeworkList"></div>
            </div>

            <!-- Statistics Tab -->
            <div id="statisticsTab" class="hidden">
                <div class="stats-grid" id="statsGrid"></div>
                <div id="detailedStats"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="schoolNameInput" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn" style="background:#ddd" onclick="closeModal('settingsModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="modal-body">
                <textarea id="noteTextarea" rows="5" class="form-input" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveNote()">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn" style="background:#ddd" onclick="closeModal('noteModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <div class="modal-body">
                <p style="margin-bottom:15px">Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±:</p>
                <div style="display:flex; flex-direction:column; gap:10px">
                    <button class="btn btn-danger" onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
                    <button class="btn btn-primary" onclick="exportToWord()">ğŸ“ ØªØµØ¯ÙŠØ± Word</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#ddd" onclick="closeModal('exportModal')">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        let appData = {
            schoolName: '',
            classes: [],
            students: [],
            attendance: [],
            participation: [],
            homework: [],
            notes: {}
        };

        let currentTab = 'classes';
        let currentNoteStudentId = null;

        // Initialize
        loadData();
        updateUI();

        function loadData() {
            const saved = localStorage.getItem('schoolAppData');
            if (saved) {
                appData = JSON.parse(saved);
            }
            updateSchoolName();
        }

        function saveData() {
            localStorage.setItem('schoolAppData', JSON.stringify(appData));
        }

        function updateSchoolName() {
            const display = document.getElementById('displaySchoolName');
            if (appData.schoolName) {
                display.textContent = appData.schoolName;
                display.classList.remove('empty');
            } else {
                display.textContent = 'Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
                display.classList.add('empty');
            }
            display.onclick = openSettings;
        }

        function openSettings() {
            document.getElementById('schoolNameInput').value = appData.schoolName || '';
            document.getElementById('settingsModal').classList.add('active');
        }

        function saveSettings() {
            appData.schoolName = document.getElementById('schoolNameInput').value.trim();
            saveData();
            updateSchoolName();
            closeModal('settingsModal');
        }

        function addClass() {
            const input = document.getElementById('classNameInput');
            const name = input.value.trim();
            if (name && !appData.classes.find(c => c.name === name)) {
                appData.classes.push({ id: Date.now(), name });
                input.value = '';
                saveData();
                updateUI();
            }
        }

        function deleteClass(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„')) {
                appData.classes = appData.classes.filter(c => c.id !== id);
                appData.students = appData.students.filter(s => s.classId !== id);
                saveData();
                updateUI();
            }
        }

        function addStudent() {
            const name = document.getElementById('studentNameInput').value.trim();
            const classId = parseInt(document.getElementById('studentClassSelect').value);
            
            if (name && classId) {
                appData.students.push({
                    id: Date.now(),
                    name,
                    classId,
                    addedAt: Date.now()
                });
                document.getElementById('studentNameInput').value = '';
                saveData();
                updateUI();
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„');
            }
        }

        function deleteStudent(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                appData.students = appData.students.filter(s => s.id !== id);
                delete appData.notes[id];
                saveData();
                updateUI();
            }
        }

        function openNoteModal(studentId) {
            currentNoteStudentId = studentId;
            document.getElementById('noteTextarea').value = appData.notes[studentId] || '';
            document.getElementById('noteModal').classList.add('active');
        }

        function saveNote() {
            const note = document.getElementById('noteTextarea').value.trim();
            if (note) {
                appData.notes[currentNoteStudentId] = note;
            } else {
                delete appData.notes[currentNoteStudentId];
            }
            saveData();
            updateUI();
            closeModal('noteModal');
        }

        function markAttendance(studentId, status) {
            const today = new Date().toLocaleDateString('ar-SA');
            const session = document.getElementById('sessionSelect').value;
            const key = `${studentId}-${today}-${session}`;
            
            const index = appData.attendance.findIndex(a => 
                a.studentId === studentId && a.date === today && a.session === session
            );
            
            if (index >= 0) {
                appData.attendance[index].status = status;
            } else {
                appData.attendance.push({ studentId, date: today, session, status });
            }
            
            saveData();
            updateUI();
        }

        function getAttendance(studentId) {
            const today = new Date().toLocaleDateString('ar-SA');
            const session = document.getElementById('sessionSelect').value;
            const record = appData.attendance.find(a => 
                a.studentId === studentId && a.date === today && a.session === session
            );
            return record ? record.status : null;
        }

        function addParticipation(studentId) {
            const today = new Date().toLocaleDateString('ar-SA');
            appData.participation.push({ studentId, date: today, timestamp: Date.now() });
            saveData();
            updateUI();
        }

        function getParticipationCount(studentId) {
            return appData.participation.filter(p => p.studentId === studentId).length;
        }

        function markHomework(studentId, status) {
            const today = new Date().toLocaleDateString('ar-SA');
            const index = appData.homework.findIndex(h => 
                h.studentId === studentId && h.date === today
            );
            
            if (index >= 0) {
                appData.homework[index].status = status;
            } else {
                appData.homework.push({ studentId, date: today, status });
            }
            
            saveData();
            updateUI();
        }

        function getHomework(studentId) {
            const today = new Date().toLocaleDateString('ar-SA');
            const record = appData.homework.find(h => 
                h.studentId === studentId && h.date === today
            );
            return record ? record.status : null;
        }

        function getFilteredStudents() {
            let filtered = [...appData.students];
            
            const search = document.getElementById('studentSearch')?.value.toLowerCase();
            if (search) {
                filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
            }
            
            const classFilter = document.getElementById('filterClass')?.value;
            if (classFilter) {
                filtered = filtered.filter(s => s.classId === parseInt(classFilter));
            }
            
            const sort = document.getElementById('sortStudents')?.value;
            if (sort === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (sort === 'class') {
                filtered.sort((a, b) => a.classId - b.classId);
            } else if (sort === 'recent') {
                filtered.sort((a, b) => b.addedAt - a.addedAt);
            }
            
            return filtered;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            updateUI();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨', 105, 15, { align: 'center' });
            
            const tableData = appData.students.map(s => {
                const className = appData.classes.find(c => c.id === s.classId)?.name || '';
                const participation = getParticipationCount(s.id);
                return [s.name, className, participation.toString()];
            });
            
            doc.autoTable({
                head: [['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª']],
                body: tableData,
                startY: 25
            });
            
            doc.save('students_report.pdf');
            closeModal('exportModal');
        }

        function exportToExcel() {
            const data = appData.students.map(s => ({
                'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': s.name,
                'Ø§Ù„ÙØµÙ„': appData.classes.find(c => c.id === s.classId)?.name || '',
                'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª': getParticipationCount(s.id),
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': appData.notes[s.id] || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
            XLSX.writeFile(wb, 'students_data.xlsx');
            closeModal('exportModal');
        }

        function exportToWord() {
            let html = '<html dir="rtl"><head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨</title></head><body>';
            html += `<h1 style="text-align:center">${appData.schoolName || 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨'}</h1>`;
            html += '<table border="1" style="width:100%; border-collapse:collapse; margin-top:20px">';
            html += '<tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>';
            
            appData.students.forEach
